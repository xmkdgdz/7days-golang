# 一致性哈希

通过一致性哈希算法从单节点实现分布式


## 算法原理

### 步骤

一致性哈希算法将 key 映射到 2^32 的空间中，将这个数字首尾相连，形成一个环

计算机器放在环上

计算 key 的哈希值放在环上，顺时针寻找到的第一个节点，就是应选取的机器

在新增/删除节点时，只需要重新定位该节点附近的一小部分数据，而不需要重新定位所有的节点

### 数据倾斜问题

如果服务器的节点过少，容易引起 key 的倾斜。例如集中分布在环的某部分，被分配给同一节点，key 过度倾斜，缓存节点间负载不均。

所以引入虚拟节点的概念

假设 1 个真实节点对应 3 个虚拟节点，那么 peer1 对应的虚拟节点是 peer1-1、 peer1-2、 peer1-3（通常以添加编号的方式实现），其余节点也以相同的方式操作。

1. 计算虚拟节点的 Hash 值，放置在环上。

2. 计算 key 的 Hash 值，在环上顺时针寻找到应选取的虚拟节点，例如是 peer2-1，那么就对应真实节点 peer2。

虚拟节点扩充了节点的数量，解决了节点较少的情况下数据容易倾斜的问题。而且代价非常小，只需要增加一个字典(map)维护真实节点与虚拟节点的映射关系即可。
